IMPORT prelude
IMPORT daydate
IMPORT jurisdiction

§ `Legal Persons Library`

-- Library for representing legal persons: natural persons and corporate entities
-- Natural persons have birthdates, citizenships, IDs, names, and addresses
-- Corporate persons have names, addresses, jurisdiction of incorporation, and IDs
-- Version 1.0.0 (2024-12-16)

§§ `Version`

`Legal Persons Library Version` MEANS "1.0.0"
`Legal Persons Library Date` MEANS "2024-12-16"


§§ `Name Types`

-- Common name components for natural persons

GIVEN firstName IS A STRING
      lastName IS A STRING
GIVETH A STRING
`full name` MEANS
    CONCAT firstName, CONCAT " ", lastName

GIVEN firstName IS A STRING
      middleName IS A STRING
      lastName IS A STRING
GIVETH A STRING
`full name with middle` MEANS
    CONCAT firstName, CONCAT " ", CONCAT middleName, CONCAT " ", lastName

GIVEN prefix IS A STRING
      firstName IS A STRING
      lastName IS A STRING
GIVETH A STRING
`formal name` MEANS
    CONCAT prefix, CONCAT " ", CONCAT firstName, CONCAT " ", lastName


§§ `Address Components`

-- Address validation and formatting functions

GIVEN street IS A STRING
      city IS A STRING
      state IS A STRING
      postalCode IS A STRING
      countryCode IS A STRING
GIVETH A STRING
`format address` MEANS
    CONCAT stateWithPostal, CONCAT ", ", countryCode
    WHERE
        streetAndCity MEANS CONCAT street, CONCAT ", ", city
        cityWithState MEANS CONCAT streetAndCity, CONCAT ", ", state
        stateWithPostal MEANS CONCAT cityWithState, CONCAT " ", postalCode

GIVEN postalCode IS A STRING
GIVETH A BOOLEAN
`is valid US zip code` MEANS
    STRINGLENGTH postalCode EQUALS 5
    OR STRINGLENGTH postalCode EQUALS 10  -- ZIP+4 format: 12345-6789

GIVEN postalCode IS A STRING
GIVETH A BOOLEAN
`is valid UK postcode` MEANS
    STRINGLENGTH postalCode AT LEAST 5
    AND STRINGLENGTH postalCode AT MOST 8

GIVEN postalCode IS A STRING
GIVETH A BOOLEAN
`is valid Canadian postal code` MEANS
    STRINGLENGTH postalCode EQUALS 7  -- Format: A1A 1A1


§§ `Natural Person Identity Documents`

-- Common identity document types and validation

`Passport type` MEANS "PASSPORT"
`National ID type` MEANS "NATIONAL_ID"
`Drivers License type` MEANS "DRIVERS_LICENSE"
`Social Security type` MEANS "SSN"
`Tax ID type` MEANS "TAX_ID"
`Residence Permit type` MEANS "RESIDENCE_PERMIT"


GIVEN ssn IS A STRING
GIVETH A BOOLEAN
`is valid US SSN format` MEANS
    STRINGLENGTH ssn EQUALS 11  -- Format: XXX-XX-XXXX
    AND SUBSTRING ssn 3 1 EQUALS "-"
    AND SUBSTRING ssn 6 1 EQUALS "-"

GIVEN sin IS A STRING
GIVETH A BOOLEAN
`is valid Canadian SIN format` MEANS
    STRINGLENGTH sin EQUALS 11  -- Format: XXX-XXX-XXX
    AND SUBSTRING sin 3 1 EQUALS "-"
    AND SUBSTRING sin 7 1 EQUALS "-"

GIVEN nino IS A STRING
GIVETH A BOOLEAN
`is valid UK NINO format` MEANS
    STRINGLENGTH nino EQUALS 9  -- Format: AB123456C


§§ `Natural Person Age Calculations`

GIVEN birthDate IS A DATE
      referenceDate IS A DATE
GIVETH A NUMBER
`age in years` MEANS
    years MINUS adjustment
    WHERE
        years MEANS DATE_YEAR referenceDate MINUS DATE_YEAR birthDate
        adjustment MEANS
            BRANCH
                IF DATE_MONTH referenceDate LESS THAN DATE_MONTH birthDate
                THEN 1
                IF DATE_MONTH referenceDate EQUALS DATE_MONTH birthDate
                        AND DATE_DAY referenceDate LESS THAN DATE_DAY birthDate
                THEN 1
                OTHERWISE 0

GIVEN birthDate IS A DATE
GIVETH A NUMBER
`current age` MEANS
    `age in years` birthDate TODAY

GIVEN birthDate IS A DATE
      minimumAge IS A NUMBER
      referenceDate IS A DATE
GIVETH A BOOLEAN
`is at least age` MEANS
    `age in years` birthDate referenceDate AT LEAST minimumAge

GIVEN birthDate IS A DATE
      minimumAge IS A NUMBER
GIVETH A BOOLEAN
`is currently at least age` MEANS
    `is at least age` birthDate minimumAge TODAY


§§ `Legal Capacity Checks`

GIVEN birthDate IS A DATE
      jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`is adult` MEANS
    BRANCH
        IF jurisdictionCode EQUALS `United States alpha-2`
        THEN `current age` birthDate AT LEAST 18
        IF jurisdictionCode EQUALS `United Kingdom alpha-2`
        THEN `current age` birthDate AT LEAST 18
        IF jurisdictionCode EQUALS `Canada alpha-2`
        THEN `current age` birthDate AT LEAST 18
        IF jurisdictionCode EQUALS `Japan alpha-2`
        THEN `current age` birthDate AT LEAST 20
        IF jurisdictionCode EQUALS `South Korea alpha-2`
        THEN `current age` birthDate AT LEAST 19
        OTHERWISE `current age` birthDate AT LEAST 18  -- Default to 18

GIVEN birthDate IS A DATE
      jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`is minor` MEANS
    NOT `is adult` birthDate jurisdictionCode

GIVEN birthDate IS A DATE
      jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`can enter contract` MEANS
    `is adult` birthDate jurisdictionCode

GIVEN birthDate IS A DATE
      jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`can vote` MEANS
    BRANCH
        IF jurisdictionCode EQUALS `United States alpha-2`
        THEN `current age` birthDate AT LEAST 18
        IF jurisdictionCode EQUALS `United Kingdom alpha-2`
        THEN `current age` birthDate AT LEAST 18
        IF jurisdictionCode EQUALS `Canada alpha-2`
        THEN `current age` birthDate AT LEAST 18
        IF jurisdictionCode EQUALS `Japan alpha-2`
        THEN `current age` birthDate AT LEAST 18
        IF jurisdictionCode EQUALS `Brazil alpha-2`
        THEN `current age` birthDate AT LEAST 16
        OTHERWISE `current age` birthDate AT LEAST 18  -- Default


§§ `Citizenship Status`

-- Helper functions for citizenship and residency

GIVEN citizenshipCode IS A STRING
      countryCode IS A STRING
GIVETH A BOOLEAN
`is citizen of` MEANS
    citizenshipCode EQUALS countryCode

GIVEN citizenships IS A LIST OF STRING
      countryCode IS A STRING
GIVETH A BOOLEAN
`has citizenship in` MEANS
    CONSIDER citizenships
    WHEN EMPTY THEN FALSE
    WHEN x FOLLOWED BY xs THEN
        BRANCH
            IF x EQUALS countryCode
            THEN TRUE
            OTHERWISE `has citizenship in` xs countryCode

GIVEN citizenships IS A LIST OF STRING
GIVETH A BOOLEAN
`has multiple citizenships` MEANS
    CONSIDER citizenships
    WHEN EMPTY THEN FALSE
    WHEN first FOLLOWED BY xs THEN NOT (xs EQUALS EMPTY)

GIVEN citizenships IS A LIST OF STRING
GIVETH A NUMBER
`citizenship count` MEANS
    CONSIDER citizenships
    WHEN EMPTY THEN 0
    WHEN first FOLLOWED BY xs THEN 1 PLUS `citizenship count` xs


§§ `Corporate Entity Types`

-- Common corporate entity structures

`Corporation type` MEANS "CORPORATION"
`LLC type` MEANS "LLC"
`LLP type` MEANS "LLP"
`Partnership type` MEANS "PARTNERSHIP"
`Sole Proprietorship type` MEANS "SOLE_PROPRIETORSHIP"
`Non-Profit type` MEANS "NON_PROFIT"
`Cooperative type` MEANS "COOPERATIVE"
`Trust type` MEANS "TRUST"
`Foundation type` MEANS "FOUNDATION"


§§ `Corporate Identifier Validation`

GIVEN ein IS A STRING
GIVETH A BOOLEAN
`is valid US EIN format` MEANS
    STRINGLENGTH ein EQUALS 10  -- Format: XX-XXXXXXX
    AND SUBSTRING ein 2 1 EQUALS "-"

GIVEN crn IS A STRING
GIVETH A BOOLEAN
`is valid UK CRN format` MEANS
    STRINGLENGTH crn EQUALS 8  -- Format: 8 digits or 2 letters + 6 digits

GIVEN bn IS A STRING
GIVETH A BOOLEAN
`is valid Canadian BN format` MEANS
    STRINGLENGTH bn EQUALS 9  -- Format: 9 digits


§§ `Corporate Status Checks`

GIVEN incorporationDate IS A DATE
GIVETH A NUMBER
`years since incorporation` MEANS
    DATE_YEAR TODAY MINUS DATE_YEAR incorporationDate

GIVEN incorporationDate IS A DATE
      minimumYears IS A NUMBER
GIVETH A BOOLEAN
`established for at least` MEANS
    `years since incorporation` incorporationDate AT LEAST minimumYears

GIVEN incorporationDate IS A DATE
      dissolutionDate IS A DATE
GIVETH A BOOLEAN
`is dissolved` MEANS
    `__LT__` dissolutionDate TODAY

GIVEN incorporationDate IS A DATE
GIVETH A BOOLEAN
`is active corporation` MEANS
    `__LT__` incorporationDate TODAY


§§ `Corporate Relationship Types`

`Wholly-owned subsidiary relationship` MEANS "WHOLLY_OWNED_SUBSIDIARY"
`Majority-owned subsidiary relationship` MEANS "MAJORITY_OWNED_SUBSIDIARY"
`Minority stake relationship` MEANS "MINORITY_STAKE"
`Joint venture relationship` MEANS "JOINT_VENTURE"
`Parent company relationship` MEANS "PARENT_COMPANY"
`Sister company relationship` MEANS "SISTER_COMPANY"
`Affiliated entity relationship` MEANS "AFFILIATED_ENTITY"


§§ `Beneficial Ownership`

GIVEN ownershipPercentage IS A NUMBER
GIVETH A BOOLEAN
`is beneficial owner` MEANS
    ownershipPercentage AT LEAST 25  -- Common threshold: 25%

GIVEN ownershipPercentage IS A NUMBER
GIVETH A BOOLEAN
`is majority owner` MEANS
    ownershipPercentage GREATER THAN 50

GIVEN ownershipPercentage IS A NUMBER
GIVETH A BOOLEAN
`is controlling owner` MEANS
    ownershipPercentage GREATER THAN 50

GIVEN ownershipPercentage IS A NUMBER
GIVETH A BOOLEAN
`has significant control` MEANS
    ownershipPercentage AT LEAST 25


§§ `Corporate Jurisdiction Functions`

GIVEN jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`is Delaware corporation` MEANS
    jurisdictionCode EQUALS `Delaware code`

GIVEN jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`is UK corporation` MEANS
    jurisdictionCode EQUALS `United Kingdom alpha-2`
    OR jurisdictionCode EQUALS `England code`
    OR jurisdictionCode EQUALS `Scotland code`
    OR jurisdictionCode EQUALS `Wales code`
    OR jurisdictionCode EQUALS `Northern Ireland code`

GIVEN jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`is Canadian corporation` MEANS
    SUBSTRING jurisdictionCode 0 2 EQUALS `Canada alpha-2`

GIVEN jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`is US corporation` MEANS
    SUBSTRING jurisdictionCode 0 2 EQUALS `United States alpha-2`


§§ `Registered Agent Information`

-- Functions for managing registered agent requirements

GIVEN jurisdictionCode IS A STRING
GIVETH A BOOLEAN
`requires registered agent` MEANS
    `is US corporation` jurisdictionCode
    OR `is UK corporation` jurisdictionCode
    OR `is Canadian corporation` jurisdictionCode

GIVEN businessJurisdiction IS A STRING
      operatingJurisdiction IS A STRING
GIVETH A BOOLEAN
`is foreign qualification required` MEANS
    NOT businessJurisdiction EQUALS operatingJurisdiction
    AND `is US corporation` businessJurisdiction
    AND `is US corporation` operatingJurisdiction
