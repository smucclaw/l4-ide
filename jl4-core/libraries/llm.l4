-- L4 Library for LLM Integration
-- Generic utilities for calling Large Language Models via HTTP APIs
--
-- Supports:
-- - Anthropic Claude API (direct)
-- - OpenAI API (direct)
-- - OpenRouter (unified gateway for 500+ models)

-- ============================================================================
-- Type Definitions
-- ============================================================================

DECLARE `Message` HAS
  `role`    IS A STRING
  `content` IS A STRING

-- ============================================================================
-- Helper: Create Message
-- ============================================================================

GIVEN role IS A STRING
      content IS A STRING
createMessage MEANS
  `Message` WITH
    `role` IS role
    `content` IS content

-- ============================================================================
-- Anthropic Claude API
-- ============================================================================

DECIDE anthropicEndpoint IS
  "https://api.anthropic.com/v1/messages"

DECIDE anthropicVersion IS
  "2023-06-01"

DECIDE buildAnthropicHeaders apiKey IS
  CONCAT
    "x-api-key: ", apiKey, "\n",
    "anthropic-version: ", anthropicVersion, "\n",
    "content-type: application/json"

DECIDE buildAnthropicBody model prompt maxTokens IS
  CONCAT
    "{\"model\":\"", model,
    "\",\"max_tokens\":", (maxTokens AS STRING),
    ",\"messages\":[",
    JSONENCODE (createMessage "user" prompt),
    "]}"

DECIDE callAnthropic apiKey model prompt maxTokens IS
  POST
    anthropicEndpoint
    (buildAnthropicHeaders apiKey)
    (buildAnthropicBody model prompt maxTokens)

-- Convenience: Claude 3.5 Sonnet with sensible defaults
DECIDE callClaude apiKey prompt IS
  callAnthropic apiKey "claude-sonnet-4-5-20250929" prompt 1000

-- ============================================================================
-- OpenAI API
-- ============================================================================

DECIDE openaiEndpoint IS
  "https://api.openai.com/v1/chat/completions"

DECIDE buildOpenAIHeaders apiKey IS
  CONCAT
    "content-type: application/json\n",
    "authorization: Bearer ", apiKey

DECIDE buildOpenAIBody model prompt maxTokens IS
  CONCAT
    "{\"model\":\"", model,
    "\",\"max_tokens\":", (maxTokens AS STRING),
    ",\"messages\":[",
    JSONENCODE (createMessage "user" prompt),
    "]}"

DECIDE callOpenAI apiKey model prompt maxTokens IS
  POST
    openaiEndpoint
    (buildOpenAIHeaders apiKey)
    (buildOpenAIBody model prompt maxTokens)

-- Convenience: GPT-4 with sensible defaults
DECIDE callGPT4 apiKey prompt IS
  callOpenAI apiKey "gpt-4" prompt 1000

-- ============================================================================
-- OpenRouter (Unified Gateway for 500+ Models)
-- ============================================================================

DECIDE openrouterEndpoint IS
  "https://openrouter.ai/api/v1/chat/completions"

DECIDE buildOpenRouterHeaders apiKey IS
  CONCAT
    "content-type: application/json\n",
    "authorization: Bearer ", apiKey, "\n",
    "http-referer: https://l4-lang.org\n",
    "x-title: L4 Legal DSL"

DECIDE buildOpenRouterBody model prompt maxTokens IS
  CONCAT
    "{\"model\":\"", model,
    "\",\"max_tokens\":", (maxTokens AS STRING),
    ",\"messages\":[",
    JSONENCODE (createMessage "user" prompt),
    "]}"

DECIDE callOpenRouter apiKey model prompt maxTokens IS
  POST
    openrouterEndpoint
    (buildOpenRouterHeaders apiKey)
    (buildOpenRouterBody model prompt maxTokens)

-- ============================================================================
-- Multi-Provider Fallback with BRANCH
-- ============================================================================

-- Query with automatic provider fallback
-- Tries: OpenRouter → OpenAI → Anthropic
DECIDE queryLLM model prompt maxTokens IS
  CONSIDER ENV "OPENROUTER_API_KEY"
    WHEN JUST openrouterKey THEN
      callOpenRouter openrouterKey model prompt maxTokens
    WHEN NOTHING THEN
      CONSIDER ENV "OPENAI_API_KEY"
        WHEN JUST openaiKey THEN
          callOpenAI openaiKey model prompt maxTokens
        WHEN NOTHING THEN
          CONSIDER ENV "ANTHROPIC_API_KEY"
            WHEN JUST anthropicKey THEN
              callAnthropic anthropicKey model prompt maxTokens
            WHEN NOTHING THEN
              "ERROR: No LLM API keys configured. Set OPENROUTER_API_KEY, OPENAI_API_KEY, or ANTHROPIC_API_KEY"

-- Convenience: Query with sensible model defaults per provider
DECIDE queryLLMWithDefaults prompt IS
  CONSIDER ENV "OPENROUTER_API_KEY"
    WHEN JUST openrouterKey THEN
      callOpenRouter openrouterKey "anthropic/claude-3.5-sonnet" prompt 1000
    WHEN NOTHING THEN
      CONSIDER ENV "OPENAI_API_KEY"
        WHEN JUST openaiKey THEN
          callOpenAI openaiKey "gpt-4" prompt 1000
        WHEN NOTHING THEN
          CONSIDER ENV "ANTHROPIC_API_KEY"
            WHEN JUST anthropicKey THEN
              callAnthropic anthropicKey "claude-sonnet-4-5-20250929" prompt 1000
            WHEN NOTHING THEN
              "ERROR: No LLM API keys configured"

-- ============================================================================
-- Response Parsing Helpers
-- ============================================================================

-- Parse JSON response (returns EITHER STRING value)
DECIDE parseResponse jsonString IS
  JSONDECODE jsonString

-- ============================================================================
-- Response Type Definitions
-- ============================================================================

-- OpenAI/OpenRouter response structure
DECLARE `OpenAIMessage` HAS
  `role`    IS A STRING
  `content` IS A STRING

DECLARE `OpenAIChoice` HAS
  `message` IS AN `OpenAIMessage`
  `finish_reason` IS A STRING

DECLARE `OpenAIResponse` HAS
  `choices` IS A LIST OF `OpenAIChoice`

-- Anthropic response structure
DECLARE `AnthropicContentBlock` HAS
  `type` IS A STRING
  `text` IS A STRING

DECLARE `AnthropicResponse` HAS
  `content` IS A LIST OF `AnthropicContentBlock`
  `stop_reason` IS A STRING

-- ============================================================================
-- Response Content Extraction
-- ============================================================================

-- Extract content from OpenAI/OpenRouter response
-- Input: Decoded JSON object of type OpenAIResponse
-- Output: EITHER error message (LEFT) or extracted content text (RIGHT)
DECIDE extractOpenAIContent jsonObj IS
  CONSIDER jsonObj
    WHEN `OpenAIResponse` WITH
      `choices` IS choices
    THEN
      CONSIDER choices
        WHEN [] THEN
          LEFT "No choices in response"
        WHEN (choice :: _) THEN
          CONSIDER choice
            WHEN `OpenAIChoice` WITH
              `message` IS msg
            THEN
              CONSIDER msg
                WHEN `OpenAIMessage` WITH
                  `content` IS text
                THEN
                  RIGHT text
                ELSE
                  LEFT "Invalid message structure"
            ELSE
              LEFT "Invalid choice structure"
        ELSE
          LEFT "Invalid choices structure"
    ELSE
      LEFT "Invalid OpenAI response structure"

-- Extract content from Anthropic response
-- Input: Decoded JSON object of type AnthropicResponse
-- Output: EITHER error message (LEFT) or extracted content text (RIGHT)
DECIDE extractAnthropicContent jsonObj IS
  CONSIDER jsonObj
    WHEN `AnthropicResponse` WITH
      `content` IS contentBlocks
    THEN
      CONSIDER contentBlocks
        WHEN [] THEN
          LEFT "No content blocks in response"
        WHEN (block :: _) THEN
          CONSIDER block
            WHEN `AnthropicContentBlock` WITH
              `text` IS text
            THEN
              RIGHT text
            ELSE
              LEFT "Invalid content block structure"
        ELSE
          LEFT "Invalid content structure"
    ELSE
      LEFT "Invalid Anthropic response structure"

-- ============================================================================
-- Unified Response Extraction
-- ============================================================================

-- Extract LLM response content with automatic provider detection
-- Input: provider name ("openai", "openrouter", or "anthropic") and raw JSON string
-- Output: EITHER error message (LEFT) or extracted content (RIGHT)
DECIDE extractLLMResponse provider jsonString IS
  CONSIDER parseResponse jsonString
    WHEN LEFT error THEN
      LEFT (CONCAT "JSON parse error: " error)
    WHEN RIGHT jsonObj THEN
      CONSIDER provider
        WHEN "openai" THEN extractOpenAIContent jsonObj
        WHEN "openrouter" THEN extractOpenAIContent jsonObj
        WHEN "anthropic" THEN extractAnthropicContent jsonObj
        ELSE LEFT (CONCAT "Unknown provider: " provider)

-- ============================================================================
-- Common LLM Models (for OpenRouter)
-- ============================================================================

DECIDE claudeOpusModel IS "anthropic/claude-3-opus"
DECIDE claudeSonnetModel IS "anthropic/claude-3.5-sonnet"
DECIDE gpt4Model IS "openai/gpt-4"
DECIDE gpt4TurboModel IS "openai/gpt-4-turbo"
DECIDE gpt35Model IS "openai/gpt-3.5-turbo"
DECIDE llama3Model IS "meta-llama/llama-3.1-70b-instruct"
DECIDE llama3FreeModel IS "meta-llama/llama-3.1-70b-instruct:free"
DECIDE geminiProModel IS "google/gemini-pro"

-- ============================================================================
-- Usage Examples (commented out)
-- ============================================================================

-- Example 1: Simple query with fallback
-- DECIDE answer IS queryLLMWithDefaults "What is consideration in contract law?"
-- #EVAL answer

-- Example 2: Specific provider and model
-- DECIDE response IS
--   CONSIDER ENV "OPENROUTER_API_KEY"
--     WHEN JUST key THEN
--       callOpenRouter key claudeOpusModel "Explain tort liability" 2000
--     WHEN NOTHING THEN
--       "ERROR: OPENROUTER_API_KEY not set"
-- #EVAL response

-- Example 3: Direct Anthropic call
-- DECIDE claudeResponse IS
--   CONSIDER ENV "ANTHROPIC_API_KEY"
--     WHEN JUST key THEN
--       callClaude key "Define legal capacity"
--     WHEN NOTHING THEN
--       "ERROR: ANTHROPIC_API_KEY not set"
-- #EVAL claudeResponse

-- Example 4: Query and parse response (OpenRouter)
-- DECIDE rawResponse IS queryLLMWithDefaults "What is consideration in contract law?"
-- DECIDE extractedContent IS extractLLMResponse "openrouter" rawResponse
-- DECIDE finalAnswer IS
--   CONSIDER extractedContent
--     WHEN RIGHT text THEN text
--     WHEN LEFT error THEN CONCAT "Extraction error: " error
-- #EVAL finalAnswer

-- Example 5: Direct Anthropic call with parsing
-- DECIDE anthropicRaw IS
--   CONSIDER ENV "ANTHROPIC_API_KEY"
--     WHEN JUST key THEN
--       callAnthropic key "claude-sonnet-4-5-20250929" "Explain tort liability" 1000
--     WHEN NOTHING THEN
--       "ERROR: ANTHROPIC_API_KEY not set"
-- DECIDE anthropicContent IS extractLLMResponse "anthropic" anthropicRaw
-- DECIDE anthropicResult IS
--   CONSIDER anthropicContent
--     WHEN RIGHT text THEN text
--     WHEN LEFT error THEN CONCAT "Parse error: " error
-- #EVAL anthropicResult

-- Example 6: OpenAI with error handling
-- DECIDE openaiRaw IS
--   CONSIDER ENV "OPENAI_API_KEY"
--     WHEN JUST key THEN
--       callOpenAI key "gpt-4" "Define legal capacity" 500
--     WHEN NOTHING THEN
--       "ERROR: OPENAI_API_KEY not set"
-- DECIDE openaiContent IS extractLLMResponse "openai" openaiRaw
-- #EVAL openaiContent  -- Returns EITHER STRING String
