name: macOS Release (Multi-Architecture)

on:
  push:
    branches:
      - main
    tags:
      - "v*"
    paths:
      # Haskell source code
      - "jl4-core/**"
      - "jl4/**"
      - "jl4-lsp/**"
      - "jl4-repl/**"
      - "jl4-decision-service/**"
      - "jl4-websessions/**"
      - "jl4-query-plan/**"
      # Build configuration
      - "*.cabal"
      - "cabal.project"
      - "cabal.project.freeze"
      # This workflow
      - ".github/workflows/macos-release.yml"
  workflow_dispatch:
    inputs:
      create_release:
        description: "Create a GitHub release"
        required: false
        default: "false"

jobs:
  build-macos:
    name: Build macOS Release - ${{ matrix.arch }} - GHC ${{ matrix.ghc-version }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-latest # M1/M2 Apple Silicon
            ghc-version: "9.6.6"
          - arch: x86_64
            runner: macos-13 # Intel
            ghc-version: "9.6.6"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up GHC ${{ matrix.ghc-version }}
        uses: haskell-actions/setup@v2
        id: setup
        with:
          ghc-version: ${{ matrix.ghc-version }}
          cabal-version: "latest"
          cabal-update: true

      - name: Configure the build
        run: |
          cabal update
          cabal configure --enable-tests --disable-documentation
          cabal build all --dry-run

      - name: Restore cached dependencies
        uses: actions/cache/restore@v4
        id: cache
        env:
          key: ${{ runner.os }}-${{ matrix.arch }}-ghc-${{ steps.setup.outputs.ghc-version }}-cabal-${{ steps.setup.outputs.cabal-version }}
        with:
          path: ${{ steps.setup.outputs.cabal-store }}
          key: ${{ env.key }}-plan-${{ hashFiles('**/plan.json') }}
          restore-keys: ${{ env.key }}-

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: cabal build all --only-dependencies

      - name: Save cached dependencies
        uses: actions/cache/save@v4
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          path: ${{ steps.setup.outputs.cabal-store }}
          key: ${{ steps.cache.outputs.cache-primary-key }}

      - name: Build all executables
        run: cabal build all

      - name: Run tests
        run: cabal test all

      - name: Find and copy executables
        run: |
          # Create release directory
          mkdir -p release/bin

          # Find all built executables (exclude test executables)
          find dist-newstyle -type f -perm +111 -name 'jl4-*' ! -name '*-test' | while read exe; do
            echo "Found: $exe"
            cp "$exe" release/bin/
          done

          # List what we have
          echo "Release contents:"
          ls -lh release/bin/

      - name: Strip binaries and code sign
        run: |
          # Strip debug symbols to reduce size
          cd release/bin
          strip * || true

          # Code sign for distribution (ad-hoc signature)
          for exe in *; do
            codesign -s - "$exe" || true
          done

          echo "Processed binaries:"
          ls -lh

      - name: Create version info
        id: version
        run: |
          # Get version information
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            # Date-based version: YYYYMMDD.HHMM
            VERSION="$(date -u '+%Y%m%d.%H%M')"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION" > release/VERSION.txt
          echo "Architecture: ${{ matrix.arch }}" >> release/VERSION.txt
          echo "Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release/VERSION.txt
          echo "Commit: ${{ github.sha }}" >> release/VERSION.txt
          echo "GHC Version: ${{ matrix.ghc-version }}" >> release/VERSION.txt

          cat release/VERSION.txt

      - name: Create README for release
        run: |
          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            ARCH_DESC="Apple Silicon (M1/M2/M3/M4)"
            MACOS_REQ="macOS 11.0 (Big Sur) or later"
          else
            ARCH_DESC="Intel"
            MACOS_REQ="macOS 10.15 (Catalina) or later"
          fi

          cat > release/README.md << EOF
          # L4 IDE - macOS Release ($ARCH_DESC)

          This is a macOS build of the L4 IDE and related tools for $ARCH_DESC Macs.

          ## Included Executables

          - **jl4-cli** - Command-line interface for evaluating L4 files
          - **jl4-schema** - JSON schema generator
          - **jl4-lsp** - Language Server Protocol implementation
          - **jl4-repl** - Interactive Read-Eval-Print Loop
          - **jl4-decision-service** - REST API for decision evaluation
          - **jl4-websessions** - Session persistence service

          ## Quick Start

          1. Extract the archive:
             \`\`\`bash
             tar -xzf l4-ide-macos-${{ matrix.arch }}-*.tar.gz
             cd l4-ide-macos-${{ matrix.arch }}
             \`\`\`

          2. Add the bin directory to your PATH:
             \`\`\`bash
             export PATH="\$PWD/bin:\$PATH"
             \`\`\`

          3. Verify installation:
             \`\`\`bash
             jl4-cli --help
             \`\`\`

          ## Requirements

          - $MACOS_REQ
          - Architecture: ${{ matrix.arch }}
          - No additional runtime dependencies required

          ## Installation

          ### Using Homebrew (recommended - coming soon)
          \`\`\`bash
          brew tap smucclaw/l4
          brew install l4-ide
          \`\`\`

          ### Manual Installation

          #### System-wide (requires sudo)
          \`\`\`bash
          sudo cp bin/* /usr/local/bin/
          \`\`\`

          #### User installation
          \`\`\`bash
          mkdir -p ~/.local/bin
          cp bin/* ~/.local/bin/
          # Add to ~/.zshrc:
          export PATH="\$HOME/.local/bin:\$PATH"
          \`\`\`

          ## First Run

          On first run, macOS may show a security warning because the binaries
          are not notarized. To allow the app to run:

          1. Try to run the executable
          2. Go to System Preferences → Security & Privacy → General
          3. Click "Allow Anyway" next to the blocked app
          4. Try running again and click "Open"

          Or use the command line to bypass Gatekeeper:
          \`\`\`bash
          xattr -dr com.apple.quarantine bin/*
          \`\`\`

          ## Documentation

          For full documentation, visit:
          https://github.com/smucclaw/l4-ide

          ## License

          See the repository for license information.
          EOF

          cat release/README.md

      - name: Package release
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Create tar.gz archive
          cd release
          tar -czf "../l4-ide-macos-${{ matrix.arch }}-${VERSION}.tar.gz" *
          cd ..

          # Verify archive
          echo "Archive contents:"
          tar -tzf "l4-ide-macos-${{ matrix.arch }}-${VERSION}.tar.gz" | head -20

          # Get file size
          ls -lh l4-ide-macos-${{ matrix.arch }}-*.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: l4-ide-macos-${{ matrix.arch }}-${{ steps.version.outputs.VERSION }}
          path: l4-ide-macos-${{ matrix.arch }}-*.tar.gz
          retention-days: 30

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: L4 IDE ${{ steps.version.outputs.VERSION }}
          body: |
            ## L4 IDE - macOS Release (${{ matrix.arch }})

            macOS binaries for the L4 Domain-Specific Language for Law.

            **Architecture:** ${{ matrix.arch }}

            ### What's Included

            - `jl4-cli` - CLI tool for evaluating L4 files
            - `jl4-schema` - JSON schema generator
            - `jl4-lsp` - Language Server Protocol server
            - `jl4-repl` - Interactive REPL
            - `jl4-decision-service` - Decision evaluation REST API
            - `jl4-websessions` - Session persistence service

            ### Installation

            1. Download `l4-ide-macos-${{ matrix.arch }}-*.tar.gz`
            2. Extract: `tar -xzf l4-ide-macos-${{ matrix.arch }}-*.tar.gz`
            3. Allow execution: `xattr -dr com.apple.quarantine l4-ide-macos-${{ matrix.arch }}/bin/*`
            4. Add to PATH: `export PATH="$PWD/l4-ide-macos-${{ matrix.arch }}/bin:$PATH"`
            5. Verify: `jl4-cli --help`

            ### Requirements

            - macOS 10.15+ (Intel) or macOS 11.0+ (Apple Silicon)
            - Architecture: ${{ matrix.arch }}
            - No additional runtime dependencies required

            ### First Run Security Note

            These binaries are code-signed but not notarized. On first run, use:
            ```bash
            xattr -dr com.apple.quarantine bin/*
            ```

            Or allow each binary individually via System Preferences → Security & Privacy.

            ### Build Information

            - **Architecture:** ${{ matrix.arch }}
            - **GHC Version:** ${{ matrix.ghc-version }}
            - **Commit:** ${{ github.sha }}
            - **Build Date:** ${{ github.event.head_commit.timestamp }}

            ### Documentation

            For comprehensive documentation, see:
            - [Repository](https://github.com/smucclaw/l4-ide)
            - [Language Reference](https://github.com/smucclaw/l4-ide/tree/main/doc)
            - [Foundation Course](https://github.com/smucclaw/l4-ide/tree/main/doc/foundation-course-ai)

            ---

            Generated with [GitHub Actions](https://github.com/smucclaw/l4-ide/actions)
          files: |
            l4-ide-macos-${{ matrix.arch }}-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "## macOS Build Summary (${{ matrix.arch }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture:** ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GHC Version:** ${{ matrix.ghc-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Built Executables" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh release/bin/ >> $GITHUB_STEP_SUMMARY || echo "No executables found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Archive" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh l4-ide-macos-${{ matrix.arch }}-*.tar.gz >> $GITHUB_STEP_SUMMARY || echo "No archive created" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
